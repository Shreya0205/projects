import pandas as pd
import json
from numpy import genfromtxt
import pickle
import os

network=['udp','domains','tcp','http','hosts','dns','icmp']
info=['score','duration']
api=['NtQueryInformationFile','LdrGetProcedureAddress','GetCursorPos','NtClose','GetSystemMetrics','SetWindowsHookExA','CreateThread','CreateToolhelp32Snapshot','NtCreateSection','NtOpenSection','NtProtectVirtualMemory','NtResumeThread','NtUnmapViewOfSection','GetSystemTimeAsFileTime','LoadResource','RegOpenKeyExW','NtWriteFile','FindResourceA','SetFileTime','GetFileAttributesW']
result=""

dir_name = input("Enter directory name: ")

if(dir_name[-1]=="/"):
   name=dir_name[:-1]
else:
   name=dir_name

for f in os.listdir(dir_name):

        f1=name+"/"+f
        file1=open(f1,'r')
        data_file=json.load(file1)
        result=""
       
        for i in info:
            result=result+str(data_file['info'][i])+","

        for i in network:
            result=result+str(len(data_file['network'][i]))+","

        df = pd.DataFrame(data_file['behavior']['apistats'])
        df['Total'] = df.sum(axis=1)
        df.fillna(0)
        for i in api:
            if ((df.index == i).any()):
                result=result+str(df['Total'][i])+","
            else:
                result=result+'0'+","

        if 'dropped' in data_file:
                result=result+str(len(data_file['dropped']))
        else:
                result=result+'0'


        myfile = open('feature.csv', 'a')
        myfile.write(result+'\n')
        myfile.close()
        myfile2 = open('sha.txt', 'a')
        myfile2.write(f.split('.')[0]+'\n')
        myfile2.close()


X_test = genfromtxt('feature.csv', delimiter=',')
model = pickle.load(open('finalized_model.sav', 'rb'))
y_pred = model.predict(X_test)

file1 = open('sha.txt', 'r') 
Lines = file1.readlines()
j=0
result=""
for i in Lines:
    if y_pred[j] == 1.0:
        result=result+i.partition("\n")[0]+",M\n"
    else:
        result=result+i.partition("\n")[0]+",B\n"
    j=j+1

file1.close()
final = open('dynamic.csv', 'a') 
final.write("File_Hash,Predicted Label\n")
final.write(result)
final.close()
